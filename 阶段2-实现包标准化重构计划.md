# 阶段2：实现包标准化重构计划

## 概述

基于阶段1的基础包整合成果，阶段2将对实现包进行标准化重构，主要包括4个协议包、2个序列化包和1个数据格式包。目标是统一依赖关系、消除代码重复、建立统一接口标准。

## 当前状态分析

### 1. Protocol包现状

#### 1.1 依赖关系分析
- **@sker/protocol-http**: 依赖过多基础包（8个依赖），包含非必要的@sker/protocol-ucp循环依赖
- **@sker/protocol-grpc**: 同样依赖过多基础包（7个依赖），与@sker/protocol-ucp存在循环依赖
- **@sker/protocol-websocket**: 依赖结构相同（7个依赖），循环依赖问题
- **@sker/protocol-ucp**: 作为统一协议抽象层，应该是其他协议的基础，但当前存在循环依赖

#### 1.2 问题识别
1. **循环依赖**：所有protocol包都依赖@sker/protocol-ucp，而@sker/protocol-ucp同时依赖其他包
2. **依赖冗余**：每个协议包都直接依赖所有6个基础包，应该通过@sker/core统一管理
3. **接口不统一**：各协议包缺乏统一的接口设计和错误处理模式

### 2. Serialization包现状

#### 2.1 依赖关系分析
- **@sker/serialization-json**: 依赖5个基础包，结构相对合理
- **@sker/serialization-protobuf**: 依赖5个基础包，包含protobuf特定依赖

#### 2.2 问题识别
1. **依赖分散**：直接依赖基础包而非通过@sker/core
2. **缺乏统一接口**：两个序列化包没有共同的抽象接口
3. **功能重复**：可能存在相似的验证、压缩等功能

### 3. Data-UDEF包现状

#### 3.1 依赖关系
- **@sker/data-udef**: 依赖所有6个基础包，作为数据格式统一层

#### 3.2 问题识别
1. **依赖冗余**：应该通过@sker/core统一管理依赖
2. **职责不清**：与序列化包功能可能有重叠

## 阶段2重构目标

### 2.1 依赖关系标准化
1. **统一依赖@sker/core**：所有实现包只依赖@sker/core，通过core访问基础功能
2. **清晰层次结构**：建立Protocol -> Serialization -> Data-UDEF的清晰依赖链
3. **消除循环依赖**：重新设计@sker/protocol-ucp的职责和依赖关系

### 2.2 接口标准化
1. **统一协议接口**：为所有protocol包定义通用接口
2. **统一序列化接口**：为所有serialization包定义通用接口
3. **统一错误处理**：所有包使用相同的错误处理模式

### 2.3 代码复用优化
1. **共享逻辑抽象**：将共同功能提取到@sker/core或专门的共享模块
2. **工具函数统一**：消除各包中重复的工具函数
3. **配置标准化**：统一配置管理方式

## 详细重构计划

### 第一步：重新设计依赖架构 (1-2天)

#### 1.1 定义新的依赖层次

```
Layer 5: @sker/protocol-ucp (协议抽象层)
    ↑
Layer 4: @sker/protocol-http, @sker/protocol-grpc, @sker/protocol-websocket (具体协议实现)
    ↑  
Layer 3: @sker/serialization-json, @sker/serialization-protobuf (序列化层)
    ↑
Layer 2: @sker/data-udef (数据格式层) 
    ↑
Layer 1: @sker/core (基础聚合层)
```

#### 1.2 更新package.json依赖关系

**高优先级任务：**
- [ ] 更新@sker/protocol-http依赖：只依赖@sker/core + @sker/serialization-json
- [ ] 更新@sker/protocol-grpc依赖：只依赖@sker/core + @sker/serialization-protobuf  
- [ ] 更新@sker/protocol-websocket依赖：只依赖@sker/core + @sker/serialization-json
- [ ] 更新@sker/protocol-ucp依赖：只依赖@sker/core
- [ ] 更新@sker/serialization-*依赖：只依赖@sker/core + @sker/data-udef
- [ ] 更新@sker/data-udef依赖：只依赖@sker/core

### 第二步：协议包标准化 (2-3天)

#### 2.1 定义统一协议接口

**任务清单：**
- [ ] 在@sker/core中定义IProtocol基础接口
- [ ] 定义IServer、IClient、IConnection通用接口
- [ ] 定义统一的中间件接口IMiddleware
- [ ] 定义统一的配置接口IProtocolConfig

#### 2.2 重构@sker/protocol-ucp为抽象层

**任务清单：**
- [ ] 移除对具体协议包的依赖
- [ ] 重新设计为协议选择和管理器
- [ ] 实现协议工厂模式
- [ ] 提供协议适配器接口

#### 2.3 重构具体协议包

**@sker/protocol-http重构：**
- [ ] 实现统一协议接口
- [ ] 移除直接基础包依赖，通过@sker/core访问
- [ ] 统一错误处理模式
- [ ] 统一中间件实现

**@sker/protocol-grpc重构：**
- [ ] 实现统一协议接口  
- [ ] 移除直接基础包依赖
- [ ] 统一流处理接口
- [ ] 统一服务发现集成

**@sker/protocol-websocket重构：**
- [ ] 实现统一协议接口
- [ ] 移除直接基础包依赖
- [ ] 统一事件处理模式
- [ ] 统一连接管理

### 第三步：序列化包标准化 (1-2天)

#### 3.1 定义统一序列化接口

**任务清单：**
- [ ] 在@sker/core中定义ISerializer接口
- [ ] 定义ISerializerFactory工厂接口
- [ ] 定义序列化配置接口ISerializerConfig
- [ ] 定义序列化中间件接口

#### 3.2 重构序列化包

**@sker/serialization-json重构：**
- [ ] 实现统一序列化接口
- [ ] 移除直接基础包依赖
- [ ] 统一验证和转换逻辑
- [ ] 与@sker/data-udef集成

**@sker/serialization-protobuf重构：**
- [ ] 实现统一序列化接口
- [ ] 移除直接基础包依赖
- [ ] 统一schema管理
- [ ] 与@sker/data-udef集成

### 第四步：数据格式包优化 (1天)

#### 4.1 重新定义@sker/data-udef职责

**任务清单：**
- [ ] 明确作为数据格式标准层的职责
- [ ] 移除与序列化包重复的功能
- [ ] 专注于消息格式、信封、负载定义
- [ ] 提供类型映射和验证规则

#### 4.2 与序列化包集成

**任务清单：**
- [ ] 提供给序列化包使用的标准数据格式
- [ ] 定义消息格式转换接口
- [ ] 实现版本兼容性处理

### 第五步：集成测试和验证 (1-2天)

#### 5.1 构建测试

**任务清单：**
- [ ] 运行所有包的构建测试
- [ ] 检查依赖解析是否正确
- [ ] 验证类型定义完整性

#### 5.2 功能集成测试

**任务清单：**
- [ ] 测试协议包之间的互操作性
- [ ] 测试序列化包的功能完整性
- [ ] 测试端到端通信流程

#### 5.3 性能验证

**任务清单：**
- [ ] 对比重构前后的性能指标
- [ ] 验证内存使用优化效果
- [ ] 检查构建时间改进

## 成功标准

### 依赖关系标准
- ✅ 所有实现包只依赖@sker/core
- ✅ 消除所有循环依赖
- ✅ 建立清晰的5层依赖架构

### 接口标准化
- ✅ 所有协议包实现统一接口
- ✅ 所有序列化包实现统一接口
- ✅ 统一的错误处理和中间件模式

### 代码复用优化
- ✅ 消除重复代码，提高复用率>80%
- ✅ 统一配置和工具函数使用
- ✅ 改善构建时间和包大小

### 质量保证
- ✅ 所有包构建成功
- ✅ 类型检查通过
- ✅ 功能测试通过
- ✅ 性能无明显下降

## 风险评估与缓解策略

### 高风险项
1. **依赖循环解除**：可能影响现有API
   - 缓解：分步重构，保持向后兼容
   
2. **接口统一**：可能需要大量代码修改
   - 缓解：使用适配器模式过渡
   
3. **功能回归**：重构可能引入bug
   - 缓解：充分的测试覆盖

### 中风险项
1. **构建配置调整**：可能影响构建流程
   - 缓解：并行维护旧配置直到验证完成

## 时间规划

- **第1周**: 依赖架构重新设计 + 协议包标准化
- **第2周**: 序列化包标准化 + 数据格式包优化 + 集成测试

总体预期时间：**2周**

## 后续阶段预告

阶段2完成后将进入**阶段3：依赖优化和性能调优**，重点关注：
- 包体积优化
- 构建时间优化  
- 运行时性能优化
- 文档和工具链完善